"""
settings.py
═══════════════════════════════════════════════════════════════════════════════
Управление переменными окружения и конфигурацией приложения.
Все пути и ключи загружаются из .env файла.

ИСПОЛЬЗОВАНИЕ:
    from settings import PERPLEXITY_API_KEY, INPUT_DIR, OUTPUT_DIR
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# ════════════════════════════════════════════════════════════════════════════
# ЗАГРУЗКА .ENV ФАЙЛА
# ════════════════════════════════════════════════════════════════════════════

# Загружаем переменные из .env (должен быть в корне проекта)
load_dotenv()

# ════════════════════════════════════════════════════════════════════════════
# ПЕРПЛЕКСИТИ API (LLM)
# ════════════════════════════════════════════════════════════════════════════

PERPLEXITY_API_KEY = os.getenv('PERPLEXITY_API_KEY')
HF_API_KEY = os.getenv("HF_API_KEY")

if not PERPLEXITY_API_KEY:
    raise ValueError(
        "❌ КРИТИЧЕСКАЯ ОШИБКА!\n"
        "   Переменная PERPLEXITY_API_KEY не установлена.\n"
        "   Добавьте её в файл .env или переменные окружения системы."
    )

# ════════════════════════════════════════════════════════════════════════════
# ПУТИ К ПАПКАМ
# ════════════════════════════════════════════════════════════════════════════

# Корневая папка проекта
PROJECT_PATH = Path(os.getenv('PROJECT_PATH', '.'))

# Папка для входящих PDF файлов
INPUT_DIR = Path(os.getenv('INPUT_DIR', PROJECT_PATH / 'data' / 'input'))

# Папка для выходных Excel файлов
OUTPUT_DIR = Path(os.getenv('OUTPUT_DIR', PROJECT_PATH / 'data' / 'output'))

# Папка для логов
LOG_DIR = Path(os.getenv('LOG_DIR', PROJECT_PATH / 'logs'))

# Временная папка для обработки (кэш)
TEMP_DIR = Path(os.getenv('TEMP_DIR', PROJECT_PATH / 'tmp'))

# ════════════════════════════════════════════════════════════════════════════
# СОЗДАНИЕ ПАПОК ЕСЛИ ИХ НЕТ
# ════════════════════════════════════════════════════════════════════════════

for directory in [INPUT_DIR, OUTPUT_DIR, LOG_DIR, TEMP_DIR]:
    directory.mkdir(parents=True, exist_ok=True)

# ════════════════════════════════════════════════════════════════════════════
# ЛОГИРОВАНИЕ
# ════════════════════════════════════════════════════════════════════════════

LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FILE = LOG_DIR / os.getenv('LOG_FILE', 'egrn_parser.log')
LOG_FORMAT = '%(asctime)s | %(name)s | %(levelname)-8s | %(message)s'
LOG_DATE_FORMAT = '%Y-%m-%d %H:%M:%S'

# ════════════════════════════════════════════════════════════════════════════
# ПАРАМЕТРЫ ОБРАБОТКИ PDF
# ════════════════════════════════════════════════════════════════════════════

# Максимальное количество файлов обработки одновременно
MAX_FILES_BATCH = int(os.getenv('MAX_FILES_BATCH', 50))

# Минимальное количество символов в тексте PDF (если меньше - может быть скан)
MIN_TEXT_LENGTH = int(os.getenv('MIN_TEXT_LENGTH', 50))

# Максимальный размер текста для отправки в LLM (символов)
MAX_TEXT_FOR_LLM = int(os.getenv('MAX_TEXT_FOR_LLM', 90000))

# ════════════════════════════════════════════════════════════════════════════
# ПАРАМЕТРЫ LLM (ПЕРПЛЕКСИТИ)
# ════════════════════════════════════════════════════════════════════════════

LLM_MODEL = os.getenv('LLM_MODEL', 'sonar-pro')
LLM_TEMPERATURE = float(os.getenv('LLM_TEMPERATURE', 0))  # 0 = детерминированный
LLM_MAX_TOKENS = int(os.getenv('LLM_MAX_TOKENS', 10000))
LLM_TIMEOUT = int(os.getenv('LLM_TIMEOUT', 60))  # секунды

HF_MODEL = os.getenv('HF_MODEL', "DeepSeek-ai/DeepSeek-VL-7B-chat")

# ════════════════════════════════════════════════════════════════════════════
# ПАРАМЕТРЫ EXCEL
# ════════════════════════════════════════════════════════════════════════════

# Шрифт для Excel таблиц
EXCEL_FONT = os.getenv('EXCEL_FONT', 'Calibri')
EXCEL_FONT_SIZE = int(os.getenv('EXCEL_FONT_SIZE', 11))

# Высота строки для заголовков
EXCEL_HEADER_HEIGHT = int(os.getenv('EXCEL_HEADER_HEIGHT', 25))

# ════════════════════════════════════════════════════════════════════════════
# СТАНДАРТНЫЕ КОЛОНКИ ТАБЛИЦЫ (из твоей сводной таблицы)
# ════════════════════════════════════════════════════════════════════════════

DEFAULT_COLUMNS = [
    '№ п/п',
    'Адрес, комплекс',
    'Наименование здания',
    'Литера / Строение',
    'Кадастр. номер ЗУ',
    'Кадастр. номер здания',
    '№ помещения',
    'Этаж',
    'Площадь (м²)',
    'Предполагаемое назначение',
    'Статус',
    'Арендатор',
    'Подтверждение из PDF',
    'Примечания и расхождения',
    'Собственник',
    'Обременение (аренда)',
    'PDF-источник',
]

# Маппинг русских названий на английские ключи (для JSON от LLM)
COLUMNS_MAPPING = {
    'Адрес, комплекс': 'address',
    'Наименование здания': 'building_name',
    'Литера / Строение': 'litera',
    'Кадастр. номер ЗУ': 'cadastral_land',
    'Кадастр. номер здания': 'cadastral_building',
    '№ помещения': 'room_number',
    'Этаж': 'floor',
    'Площадь (м²)': 'area',
    'Предполагаемое назначение': 'purpose',
    'Статус': 'status',
    'Арендатор': 'tenant',
    'Подтверждение из PDF': 'confirmation',
    'Примечания и расхождения': 'notes',
    'Собственник': 'owner',
    'Обременение (аренда)': 'encumbrance',
    'PDF-источник': 'pdf_source',
}

# ════════════════════════════════════════════════════════════════════════════
# ВЫВОД ИНФОРМАЦИИ ПРИ ЗАГРУЗКЕ (для отладки)
# ════════════════════════════════════════════════════════════════════════════

if __name__ == "__main__":
    print("✅ Конфигурация загружена успешно:")
    print(f"   📁 INPUT_DIR: {INPUT_DIR}")
    print(f"   📁 OUTPUT_DIR: {OUTPUT_DIR}")
    print(f"   📁 LOG_DIR: {LOG_DIR}")
    print(f"   🔑 API ключ: {'***' + PERPLEXITY_API_KEY[-10:]}")
    print(f"   📊 Стандартные колонки: {len(DEFAULT_COLUMNS)}")
